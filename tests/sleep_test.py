from io import StringIO
from pathlib import Path

import numpy.testing
import pandas as pd
import pytest

import pylabfront.sleep


@pytest.fixture
def sleep_summary():
    return pd.read_csv(
        StringIO(
            """sleepSummaryId,calendarDate,timezoneOffsetInMs,unixTimestampInMs,isoDate,durationInMs,unmeasurableSleepInMs,deepSleepDurationInMs,lightSleepDurationInMs,remSleepInMs,awakeDurationInMs,overallSleepQualifier,overallSleepScore,validation,totalDurationQualifier,awakeCountQualifier,restlessnessQualifier,stressQualifier,remPercentageQualifier,lightPercentageQualifier,deepPercentageQualifier
            x4c64722-64595538-6630,2023-05-09,7200000,1683576120000,2023-05-08T22:02:00.000+02:00,26160000,0,3900000,15480000,6780000,780000,GOOD,88,ENHANCED_FINAL,GOOD,GOOD,EXCELLENT,EXCELLENT,EXCELLENT,GOOD,FAIR
            x4c64722-645ab9b4-55c8,2023-05-10,7200000,1683667380000,2023-05-09T23:23:00.000+02:00,21960000,0,3420000,12780000,5760000,120000,FAIR,79,ENHANCED_FINAL,FAIR,EXCELLENT,EXCELLENT,EXCELLENT,EXCELLENT,EXCELLENT,FAIR
            x4c64722-645bf6d0-6888,2023-05-11,7200000,1683748560000,2023-05-10T21:56:00.000+02:00,26760000,0,6420000,12060000,8280000,480000,EXCELLENT,91,ENHANCED_FINAL,GOOD,EXCELLENT,EXCELLENT,EXCELLENT,GOOD,EXCELLENT,EXCELLENT
            x4c64722-645d63f8-5c94,2023-05-12,7200000,1683842040000,2023-05-11T23:54:00.000+02:00,23700000,0,4260000,9600000,9840000,0,FAIR,70,ENHANCED_FINAL,FAIR,EXCELLENT,EXCELLENT,FAIR,POOR,EXCELLENT,EXCELLENT
            """
        ),
        index_col=0,
    )


@pytest.fixture
def sleep_stages():
    return pd.read_csv(
        StringIO(
            """sleepSummaryId,timezoneOffsetInMs,unixTimestampInMs,isoDate,durationInMs,type
            x4c64722-64595538-6630,7200000,1683576120000,2023-05-08T22:02:00.000+02:00,600000,light
            x4c64722-64595538-6630,7200000,1683576720000,2023-05-08T22:12:00.000+02:00,960000,deep
            x4c64722-64595538-6630,7200000,1683577680000,2023-05-08T22:28:00.000+02:00,60000,awake
            x4c64722-64595538-6630,7200000,1683577740000,2023-05-08T22:29:00.000+02:00,600000,light
            x4c64722-64595538-6630,7200000,1683578340000,2023-05-08T22:39:00.000+02:00,720000,deep
            x4c64722-64595538-6630,7200000,1683579060000,2023-05-08T22:51:00.000+02:00,1800000,light
            x4c64722-64595538-6630,7200000,1683580860000,2023-05-08T23:21:00.000+02:00,2700000,rem
            x4c64722-64595538-6630,7200000,1683583560000,2023-05-09T00:06:00.000+02:00,840000,light
            x4c64722-64595538-6630,7200000,1683584400000,2023-05-09T00:20:00.000+02:00,1080000,deep
            x4c64722-64595538-6630,7200000,1683585480000,2023-05-09T00:38:00.000+02:00,2520000,light
            x4c64722-64595538-6630,7200000,1683588000000,2023-05-09T01:20:00.000+02:00,1260000,rem
            x4c64722-64595538-6630,7200000,1683589260000,2023-05-09T01:41:00.000+02:00,2760000,light
            x4c64722-64595538-6630,7200000,1683592020000,2023-05-09T02:27:00.000+02:00,360000,deep
            x4c64722-64595538-6630,7200000,1683592380000,2023-05-09T02:33:00.000+02:00,240000,light
            x4c64722-64595538-6630,7200000,1683592620000,2023-05-09T02:37:00.000+02:00,660000,awake
            x4c64722-64595538-6630,7200000,1683593280000,2023-05-09T02:48:00.000+02:00,1440000,light
            x4c64722-64595538-6630,7200000,1683594720000,2023-05-09T03:12:00.000+02:00,780000,deep
            x4c64722-64595538-6630,7200000,1683595500000,2023-05-09T03:25:00.000+02:00,540000,light
            x4c64722-64595538-6630,7200000,1683596040000,2023-05-09T03:34:00.000+02:00,2820000,rem
            x4c64722-64595538-6630,7200000,1683598860000,2023-05-09T04:21:00.000+02:00,960000,light
            x4c64722-64595538-6630,7200000,1683599820000,2023-05-09T04:37:00.000+02:00,60000,awake
            x4c64722-64595538-6630,7200000,1683599880000,2023-05-09T04:38:00.000+02:00,3180000,light
            x4c64722-645ab9b4-55c8,7200000,1683667380000,2023-05-09T23:23:00.000+02:00,600000,light
            x4c64722-645ab9b4-55c8,7200000,1683667980000,2023-05-09T23:33:00.000+02:00,1380000,deep
            x4c64722-645ab9b4-55c8,7200000,1683669360000,2023-05-09T23:56:00.000+02:00,600000,light
            x4c64722-645ab9b4-55c8,7200000,1683669960000,2023-05-10T00:06:00.000+02:00,1560000,rem
            x4c64722-645ab9b4-55c8,7200000,1683671520000,2023-05-10T00:32:00.000+02:00,720000,light
            x4c64722-645ab9b4-55c8,7200000,1683672240000,2023-05-10T00:44:00.000+02:00,1680000,deep
            x4c64722-645ab9b4-55c8,7200000,1683673920000,2023-05-10T01:12:00.000+02:00,3900000,light
            x4c64722-645ab9b4-55c8,7200000,1683677820000,2023-05-10T02:17:00.000+02:00,60000,awake
            x4c64722-645ab9b4-55c8,7200000,1683677880000,2023-05-10T02:18:00.000+02:00,2580000,light
            x4c64722-645ab9b4-55c8,7200000,1683680460000,2023-05-10T03:01:00.000+02:00,360000,deep
            x4c64722-645ab9b4-55c8,7200000,1683680820000,2023-05-10T03:07:00.000+02:00,480000,light
            x4c64722-645ab9b4-55c8,7200000,1683681300000,2023-05-10T03:15:00.000+02:00,2160000,rem
            x4c64722-645ab9b4-55c8,7200000,1683683460000,2023-05-10T03:51:00.000+02:00,360000,light
            x4c64722-645ab9b4-55c8,7200000,1683683820000,2023-05-10T03:57:00.000+02:00,60000,awake
            x4c64722-645ab9b4-55c8,7200000,1683683880000,2023-05-10T03:58:00.000+02:00,3540000,light
            x4c64722-645ab9b4-55c8,7200000,1683687420000,2023-05-10T04:57:00.000+02:00,2040000,rem
            x4c64722-645bf6d0-6888,7200000,1683748560000,2023-05-10T21:56:00.000+02:00,240000,light
            x4c64722-645bf6d0-6888,7200000,1683748800000,2023-05-10T22:00:00.000+02:00,2460000,deep
            x4c64722-645bf6d0-6888,7200000,1683751260000,2023-05-10T22:41:00.000+02:00,1860000,light
            x4c64722-645bf6d0-6888,7200000,1683753120000,2023-05-10T23:12:00.000+02:00,1980000,deep
            x4c64722-645bf6d0-6888,7200000,1683755100000,2023-05-10T23:45:00.000+02:00,600000,light
            x4c64722-645bf6d0-6888,7200000,1683755700000,2023-05-10T23:55:00.000+02:00,1260000,rem
            x4c64722-645bf6d0-6888,7200000,1683756960000,2023-05-11T00:16:00.000+02:00,1800000,light
            x4c64722-645bf6d0-6888,7200000,1683758760000,2023-05-11T00:46:00.000+02:00,420000,awake
            x4c64722-645bf6d0-6888,7200000,1683759180000,2023-05-11T00:53:00.000+02:00,960000,light
            x4c64722-645bf6d0-6888,7200000,1683760140000,2023-05-11T01:09:00.000+02:00,1260000,deep
            x4c64722-645bf6d0-6888,7200000,1683761400000,2023-05-11T01:30:00.000+02:00,300000,light
            x4c64722-645bf6d0-6888,7200000,1683761700000,2023-05-11T01:35:00.000+02:00,2880000,rem
            x4c64722-645bf6d0-6888,7200000,1683764580000,2023-05-11T02:23:00.000+02:00,1200000,light
            x4c64722-645bf6d0-6888,7200000,1683765780000,2023-05-11T02:43:00.000+02:00,720000,deep
            x4c64722-645bf6d0-6888,7200000,1683766500000,2023-05-11T02:55:00.000+02:00,1980000,light
            x4c64722-645bf6d0-6888,7200000,1683768480000,2023-05-11T03:28:00.000+02:00,2700000,rem
            x4c64722-645bf6d0-6888,7200000,1683771180000,2023-05-11T04:13:00.000+02:00,1260000,light
            x4c64722-645bf6d0-6888,7200000,1683772440000,2023-05-11T04:34:00.000+02:00,60000,awake
            x4c64722-645bf6d0-6888,7200000,1683772500000,2023-05-11T04:35:00.000+02:00,1860000,light
            x4c64722-645bf6d0-6888,7200000,1683774360000,2023-05-11T05:06:00.000+02:00,1440000,rem
            x4c64722-645d63f8-5c94,7200000,1683842040000,2023-05-11T23:54:00.000+02:00,480000,light
            x4c64722-645d63f8-5c94,7200000,1683842520000,2023-05-12T00:02:00.000+02:00,3000000,deep
            x4c64722-645d63f8-5c94,7200000,1683845520000,2023-05-12T00:52:00.000+02:00,600000,light
            x4c64722-645d63f8-5c94,7200000,1683846120000,2023-05-12T01:02:00.000+02:00,1560000,rem
            x4c64722-645d63f8-5c94,7200000,1683847680000,2023-05-12T01:28:00.000+02:00,1980000,light
            x4c64722-645d63f8-5c94,7200000,1683849660000,2023-05-12T02:01:00.000+02:00,300000,deep
            x4c64722-645d63f8-5c94,7200000,1683849960000,2023-05-12T02:06:00.000+02:00,600000,light
            x4c64722-645d63f8-5c94,7200000,1683850560000,2023-05-12T02:16:00.000+02:00,2160000,rem
            x4c64722-645d63f8-5c94,7200000,1683852720000,2023-05-12T02:52:00.000+02:00,1560000,light
            x4c64722-645d63f8-5c94,7200000,1683854280000,2023-05-12T03:18:00.000+02:00,960000,deep
            x4c64722-645d63f8-5c94,7200000,1683855240000,2023-05-12T03:34:00.000+02:00,1620000,light
            x4c64722-645d63f8-5c94,7200000,1683856860000,2023-05-12T04:01:00.000+02:00,2700000,rem
            x4c64722-645d63f8-5c94,7200000,1683859560000,2023-05-12T04:46:00.000+02:00,2760000,light
            x4c64722-645d63f8-5c94,7200000,1683862320000,2023-05-12T05:32:00.000+02:00,3420000,rem
        """
        )
    )


def test_compute_sleep_score(sleep_summary):
    sleep_score = pylabfront.sleep._compute_sleep_score(sleep_summary)
    assert type(sleep_score) == pd.Series
    numpy.testing.assert_array_equal(sleep_score.values, [88, 79, 91, 70])


def test_compute_sleep_efficiency(sleep_summary):
    sleep_efficiency = pylabfront.sleep._compute_sleep_efficiency(sleep_summary)
    assert type(sleep_efficiency) == pd.Series
    numpy.testing.assert_allclose(
        sleep_efficiency, [97.1, 99.46, 98.24, 100.0], atol=0.1
    )


def test_compute_sleep_maintenance_efficiency(sleep_summary, sleep_stages):
    sleep_maintenance_efficiency = (
        pylabfront.sleep._compute_sleep_maintenance_efficiency(
            sleep_summary, sleep_stages
        )
    )
    assert type(sleep_maintenance_efficiency) == pd.Series
    numpy.testing.assert_allclose(
        sleep_maintenance_efficiency, [97.1, 99.46, 98.24, 100.0], atol=0.1
    )
